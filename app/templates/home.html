{% extends 'layout.html' %}
{% block content %}

<div class="container hidden">
<div id="toolbar">
    <!-- <button id="button" class="btn btn-secondary">destroy</button>
    <button id="button2" class="btn btn-secondary">build</button> -->
    <button id="resetButton" class="btn btn-secondary">Reset filters</button>
</div>



        <table
            id="table"
            data-toggle="table"
            data-ajax="ajaxRequest"
            data-height="1000"
            data-buttons-align="right"
            data-show-button-text="true"
            data-search="true"
            data-search-align="right"
            data-search-accent-neutralise="true"
            data-search-on-enter-key="false"
            data-search-text=""
            data-search-time-out="2000"
            visible-search="true"
            data-sort-reset="false"
            data-silent-sort="true"
            data-side-pagination="server"
            data-pagination="true"
            data-pagination-pre-text="Previous"
            data-pagination-next-text="Next"
            data-pagination-successively-size="3"
            data-pagination-v-align="bottom"
            data-page-list="[10, 25, 50, 100, 200]"
            data-show-pagination-switch="false"
            data-show-extended-pagination="false"
            data-show-jump-to="true"
            data-remember-order="true"
            data-show-columns="true"
            data-show-columns-search="true"
            data-show-columns-toggle-all="true"
            data-show-header="true"
            data-show-footer="false"
            data-show-fullscreen="false"
            data-show-refresh="false"
            data-show-toggle="true"
            data-smart-display="true"
            data-undefined-text="N/A"
            data-virtual-scroll="true"
            data-addrbar="false"
            data-show-export="false"
            data-export-data-type="basic"
            data-filter-control="true"
            data-mobile-responsive="true"
            data-show-print="true"
            data-reorderable-columns="false"
            data-header-style="headerStyle"
            data-toolbar="#toolbar"
            data-detail-view="true"
            data-detail-formatter="detailFormatter"
            data-detail-view-by-click="false"
            data-loading-template="loadingTemplate"
        >
            <thead>
                <tr>
                    <!--
                    loanamount,city,state,zip,naicscode,businesstype,raceethnicity,gender,veteran,nonprofit,jobsretained,dateapproved,lender,cd
                    -->
                    <th data-field="loanamount"     data-sortable="true" data-filter-control="input"    data-sort-order="desc" data-formatter="amountFormatter"               >Loan Amount</th>
                    <th data-field="city"           data-sortable="true" data-filter-control="input"                                                                          >City</th>
                    <th data-field="state"          data-sortable="true" data-filter-control="select"   data-filter-data="obj:newTry.state"                                   >State</th>
                    <th data-field="zip"            data-sortable="true" data-filter-control="input"                                                                          >ZIP Code</th>
                    <th data-field="naicscode"      data-sortable="true" data-filter-control="select"   data-filter-data="obj:newTry.naicscode"       data-visible="false"    >NAICS Code</th>
                    <th data-field="businesstype"   data-sortable="true" data-filter-control="select"   data-filter-data="obj:newTry.businesstype"    data-visible="false"    >Business Type</th>
                    <th data-field="raceethnicity"  data-sortable="true" data-filter-control="select"   data-filter-data="obj:newTry.raceethnicity"                           >Race&#47;Ethnicity</th>
                    <th data-field="gender"         data-sortable="true" data-filter-control="select"   data-filter-data="obj:newTry.gender"                                  >Gender</th>
                    <th data-field="veteran"        data-sortable="true" data-filter-control="select"   data-filter-data="obj:newTry.veteran"         data-visible="false"    >Veteran</th>
                    <th data-field="nonprofit"      data-sortable="true" data-filter-control="select"   data-filter-data="obj:newTry.nonprofit"       data-visible="false"    >Nonprofit</th>
                    <th data-field="jobsretained"   data-sortable="true" data-filter-control="input"                                                                          >Jobs Retained</th>
                    <th data-field="dateapproved"   data-sortable="true" data-filter-control="select"   data-filter-data="obj:newTry.dateapproved"    data-visible="false"    >Date Approved</th>
                    <th data-field="lender"         data-sortable="true" data-filter-control="input"                                                  data-visible="false"    >Lender</th>
                    <th data-field="cd"             data-sortable="true" data-filter-control="select"   data-filter-data="obj:newTry.cd"                                      >House District</th>
                </tr>
            </thead>
        </table>


        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>

        <!-- Export data -->
        <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.2/dist/FileSaver.min.js"></script>
        <script src="https://unpkg.com/tableexport.jquery.plugin/libs/jsPDF/jspdf.min.js"></script>
        <script src="https://unpkg.com/tableexport.jquery.plugin/libs/jsPDF-AutoTable/jspdf.plugin.autotable.js"></script> 
        <script src="https://unpkg.com/tableexport.jquery.plugin/tableExport.min.js"></script>


        <!-- Reorder columns -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/akottr/dragtable@master/jquery.dragtable.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/bootstrap-table@1.17.1/dist/bootstrap-table.min.js"></script>

        <!-- Extensions -->
        <script src="https://unpkg.com/bootstrap-table@1.17.1/dist/extensions/addrbar/bootstrap-table-addrbar.min.js"></script>
        <script src="https://unpkg.com/bootstrap-table@1.17.1/dist/extensions/export/bootstrap-table-export.min.js"></script>
        <script src="https://unpkg.com/bootstrap-table@1.17.1/dist/extensions/mobile/bootstrap-table-mobile.min.js"></script>
        <script src="https://unpkg.com/bootstrap-table@1.17.1/dist/extensions/page-jump-to/bootstrap-table-page-jump-to.min.js"></script>
        <script src="https://unpkg.com/bootstrap-table@1.17.1/dist/extensions/print/bootstrap-table-print.min.js"></script>
        <!-- <script src="https://unpkg.com/bootstrap-table@1.17.1/dist/extensions/reorder-columns/bootstrap-table-reorder-columns.min.js"></script> -->


        <!-- <script src="{{ url_for('static',filename='js/bootstrap-table-filter-control.js') }}"></script> -->
        <script src="https://unpkg.com/bootstrap-table@1.17.1/dist/extensions/filter-control/bootstrap-table-filter-control.min.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.14.1/locale/bootstrap-table-en-US.min.js"></script>




<script>
        $(document).ready(function () {
            $('div.hidden').fadeIn(2000).removeClass('hidden');
        });
</script>


        <script>var newTry;</script>
        <script>
            function getColumnNames() {
                var request = new XMLHttpRequest();
                request.open('GET', 'http://localhost:5000/header_options/', false);  // `false` makes the request synchronous
                request.send(null);

                if (request.status === 200) {
                    // console.log(request.responseText)
                    newTry = JSON.parse(request.responseText);
                    // console.log('DOT REQUEST:')
                    // console.log(newTry.state)
                    // console.log(newTry)
                    // console.log("PROPERTIES PRINT")
                    // console.log(Object.getOwnPropertyNames(newTry));
                    // $table.bootstrapTable('removeAll')

                    // console.log("TRYING NEW TRY")
                    // console.log(newTry)
                    // $table.bootstrapTable('resetSearch') // Clear value in global search box
                    // $table.bootstrapTable('clearFilterControl') //Unfilter results
                    // $table.bootstrapTable('refreshOptions', { //Clear column filters
                    // })
                }
            }

            getColumnNames()
        </script>

        <!-- 
        <script>
            console.log('SEPARATE SCRIPT:')
            console.log(newTry.state)
        </script>
        <script>    
            $('#table').bootstrapTable({
                onAll: function (arg1, arg2) {
                    console.log('HELLO START')
                },
                onRefresh: function(params) {
                    console.log("REFRESH PARAMS:")
                    params.filter = {}
                    console.log(params)
    
                }
            })
            </script> -->

        <script>
            // $table.bootstrapTable('hideColumn', 'city')
            var randomnum = Math.random().toString()



            // var columns = {
            //     'state': {
            //         country: randomnum,
            //         city: 'city'
            //     }
            // }

            // function functionName() {
            //     var randomnum = Math.random().toString()
            //     return {'state': randomnum,
            //             'city': 'city'}
            // }
        </script>

        <script>
        

            var $table = $('#table')
            var $button = $('#button')
            var $button2 = $('#button2')
            var $resetButton = $('#resetButton')
        
            $(function() {
                
            $button.click(function () {
                $table.bootstrapTable('refresh');
            })
            $button2.click(function () {
                $table.bootstrapTable()
            })
            })
        </script>












<!-- 
        <script>
            function makeRequest (method, url, data) {
                return new Promise(function (resolve, reject) {
                    var xhr = new XMLHttpRequest();
                    xhr.open(method, url);
                    xhr.onload = function () {
                    if (this.status >= 200 && this.status < 300) {
                        resolve(xhr.response);
                    } else {
                        reject({
                        status: this.status,
                        statusText: xhr.statusText
                        });
                    }
                    };
                    xhr.onerror = function () {
                    reject({
                        status: this.status,
                        statusText: xhr.statusText
                    });
                    };
                    if(method=="POST" && data){
                        xhr.send(data);
                    }else{
                        xhr.send();
                    }
                });
                }
        </script> -->

        <script>
        //     var userJobTitles8
        //     $.get("http://localhost:5000/data_test/businesstype.json", function(data){
        //         userJobTitles8 = data
        //         console.log(userJobTitles8)
         
        //     })
        //     userJobTitles8 = {
        //         'state': {
        //             Admin: 'Admin',
        //             IT: randomnum,
        //             General : 'General',
        //             Security : 'Security',
        //             CEO : 'CEO',
        //         },
        //         'zip': {
        //             Admin: 'Admin',
        //             CEO: randomnum
        //         },
        //         'businesstype': {
        //             BusinessType_1: 'BT 1',
        //             BusinessType_2: 'BT 2'
        //         }
        //     };
        // </script>
        <script>
        //     console.log("OUTSIDE")
        //     console.log(userJobTitles8)   
        //     // var userJobTitles7 = new Object()

            // $.getJSON("http://localhost:5000/data_test/businesstype.json").then(
            //     function(data, userJobTitles7) {
            //         console.log('MY JSON:')
            //         console.log(Object.keys(data))
            //         userJobTitles7 = data

            //     }
            // )
            // console.log("OUTSIDE IT")
            // console.log(userJobTitles7)
            // var myjson = userJobTitles6

            // GET example
            // makeRequest('GET', "http://localhost:5000/data_test/businesstype.json").then(function(data){
            //     var userJobTitles4=JSON.parse(data);
            // console.log("NEW")
            // console.log(userJobTitles4)
            // console.log("NEWEST:")
            // console.log(userJobTitles6)
            // });
        </script>



        <!-- Get data -->
        <script>
            // let url = 'http://localhost:5000/data_test/businesstype.json';
            // userJobTitles2 = {
            //     'state': {
            //         Admin: 'Admin',
            //         IT: randomnum,
            //         General : 'General',
            //         Security : 'Security',
            //         CEO : 'CEO',
            //     },
            //     'zip': {
            //         Admin: 'Admin',
            //         CEO: randomnum
            //     },
            //     'businesstype': {
            //         BusinessType_1: 'BT 1',
            //         BusinessType_2: 'BT 2'
            //     }
            // };
            // console.log("FIRST PRINT")
            // console.log(userJobTitles2)

            // userJobTitles2 = fetch(url)
            // .then(res => res.json())
            // .then((out) => {
            // console.log('Checkout this JSON! ', out);
            // // userJobTitles2 = out
            // // console.log("IN METHOD:")
            // // console.log(userJobTitles2)
            // // console.log(userJobTitles2.businesstype)
            // })
            // .catch(err => { throw err });
            // console.log("SECOND PRINT")
            // console.log(userJobTitles2)
            // console.log("THIS IS THE VARIABLE LOGGED:")
            // console.log(userJobTitles2)
            // userJobTitles2 = $.get('http://localhost:5000/data_test/businesstype.json')
            // console.log("COLUMN JSON:")
            // console.log(userJobTitles2)
            // userJobTitles3 = {
            //     'state': {
            //         Admin: 'Admin',
            //         IT: randomnum,
            //         General : 'General',
            //         Security : 'Security',
            //         CEO : 'CEO',
            //     },
            //     'zip': {
            //         Admin: 'Admin',
            //         CEO: randomnum
            //     },
            //     'businesstype': {
            //         BusinessType_1: 'BT 1',
            //         BusinessType_2: 'BT 2'
            //     }
            // };
            // var userJobTitles = {
            //     'state': {
            //         Admin: 'Admin',
            //         IT: randomnum,
            //         General : 'General',
            //         Security : 'Security',
            //         CEO : 'CEO',
            //     },
            //     'zip': {
            //         Admin: 'Admin',
            //         CEO: randomnum
            //     }
            // };

                function ajaxRequest(params) {
                    var url = '/params'
                    $.get(url + '?' + $.param(params.data))
                    .then(function (res) {
                        params.success(res)
                        console.log(res)
                    });
                };
        </script>

<!-- <script>
    $('#table').on('event-name.bs.table', function (e, arg1, arg2) {
        console.log('LOADING FIRST')
    })
    </script> -->


        <script>
            $('#table').on('column-switch.bs.table', function (e, arg1, arg2) {
                console.log('COLUMN SWITCH')
                $table.bootstrapTable('resetView')
                $table.bootstrapTable()
            })
            // onColumnSwitch
        </script>


        <!-- Format loan amount data -->        
        <script>
            function amountFormatter(value) {
                return value.substring(0, value.length - 3)
            }
        </script>


        <!-- Data export -->
        <!-- <script>
            $(function() {
                $('#toolbar').find('select').change(function () {
                $table.bootstrapTable('destroy').bootstrapTable({
                    exportDataType: $(this).val(),
                    exportTypes: ['json', 'xml', 'csv', 'txt', 'sql', 'pdf']
                })
                }).trigger('change')
            });
        </script> -->


        <!-- Column headers without search or filtering -->
        <script>
            $( "div:contains('Loan Amount'):last" ).parent().css({"vertical-align":"top"});
            $( "div:contains('Jobs Retained'):last" ).parent().css({"vertical-align":"top"});

            function headerStyle(column) {
                return {
                    loanamount: {
                    css: {'vertical-align': 'top'}
                    },
                    jobsretained: {
                    css: {'vertical-align': 'top'}
                    }
                }[column.field]
            }
        </script>

        <!-- Custom text for loading message, footer, search box placeholder, no match found -->
        <script>        
            (function ($) {
                'use strict';

                $.fn.bootstrapTable.locales['en-US-custom'] = {
                    formatLoadingMessage: function () {
                        return 'Doing government work';
                    },
                    formatRecordsPerPage: function (pageNumber) {
                        return pageNumber + ' results per page';
                    },
                    formatShowingRows: function (pageFrom, pageTo, totalRows) {
                        return 'Showing ' + pageFrom.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' to ' + pageTo.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' of ' + totalRows.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' loans';
                    },
                    formatSearch: function () {
                        return 'Search all columns';
                    },
                    formatNoMatches: function () {
                        return 'I\'ve got nothing for you ¯\\_(ツ)_/¯ Want to try again fewer filters?';
                    },
                    formatExport: function () {
                        return 'Export page'
                    }
                };

                $.extend($.fn.bootstrapTable.defaults, $.fn.bootstrapTable.locales['en-US-custom']);

            })(jQuery);
        </script>

        <script>

//                  var orderedColumnNames = [
//                     'loanamount',
//                     'city',
//                     'state',
//                     'zip',
//                     'naicscode',
//                     'businesstype',
//                     'raceethnicity',
//                     'gender',
//                     'veteran',
//                     'nonprofit',
//                     'jobsretained',
//                     'dateapproved',
//                     'lender',
//                     'cd'];

            var orderedData = {
                "loanamount": "Loan Amount",
                "city": "City",
                "state": "State",                
                "zip": "ZIP Code",
                "naicscode": "NAICS Code",
                "businesstype": "Business Type",
                "raceethnicity": "Race/Ethnicity",
                "gender": "Gender",
                "veteran": "Veteran",
                "nonprofit": "Nonprofit",
                "jobsretained": "Jobs Retained",
                "dateapproved": "Date Approved",
                "lender": "Lender",
                "cd": "House District"
            }

            function getOrderedColumns() {
                return Object.values(orderedData)
            }

            function reorderValues(row) {
                // console.log("TRY 1")
                // console.log(Object.keys(orderedData))
                var orderedValues = []
                $.each(Object.keys(orderedData), function(index, value) {
                    orderedValues.push(row[value])
                })
                return orderedValues
            }

            function formatValues(values) {
                var i;
                for (i = 0; i < values.length; i++) { 
                    if (values[i] == null) {
                        values[i] = "N/A"
                    }
                }
                return values
            }

            function detailFormatter(index, row) {
                var orderedColumns = getOrderedColumns()
                var orderedValues = reorderValues(row)
                orderedValues = formatValues(orderedValues)

                var html = ['<div class="detailview">']
                var i = 0
                $.each(orderedColumns, function (index, columnName) {
                    html.push('<p><b>' + columnName + ':</b> ' + orderedValues[i] + '</p>')
                    i += 1
                })
                html.push('</div>')
                return html.join('')
            }

<!-- Table reset -->
            $(function() {
                $resetButton.click(function () {
                    $table.bootstrapTable('destroy')
                    $table.bootstrapTable({
                    undefinedText: 'N/A'
                })
    ////            $table.bootstrapTable('removeAll')
                // $table.bootstrapTable('resetSearch') // Clear value in global search box
    ////            $table.bootstrapTable('clearFilterControl') //Unfilter results
    ////            $table.bootstrapTable('refreshOptions', { //Clear column filters
    ////            })
                })
            })

<!-- Load table -->
            $table.bootstrapTable(
                {
                    undefinedText: 'N/A',
                    exportTypes: ['csv', 'txt', 'doc', 'pdf', 'json', 'xml', 'sql'],
                    exportOptions: {
                        fileName: 'ppp_data',
                        ignoreColumn: [0]
                    }
                }
            )
        </script>

        <script>
            var type = 'fa'
        
            function loadingTemplate(message) {
                if (type === 'fa') {
                    return '<i style="color:#007aff;font-size:32px;">Doing government work...&nbsp;&nbsp;</i><i style="color:#007aff;" class="fa fa-spinner fa-spin fa-fw fa-2x"></i>'
                }
                if (type === 'pl') {
                    return '<div class="ph-item"><div class="ph-picture"></div></div>'
                }
            }
        
            function rebuild() {
                $('#table').bootstrapTable('destroy')
                    .bootstrapTable()
                    .bootstrapTable('showLoading')
            }
            
            $(function () {
                rebuild()
            })
        </script>

<!-- if (key == 'businesstype'){
    key = 'Business Type'
    console.log(key)
}
console.log(key) -->




<!-- 
<script>
$('#table').on('pre-body.bs.table', function (e, arg1, arg2) {
            console.log('HELLO END')
            var userJobTitles9
            fetch("http://localhost:5000/data_test/businesstype.json")
            .then(response => response.json())
            .then(response => {
                console.log("JSON IS THIS:")
                console.log(response);
                userJobTitles9 = response
                console.log("ASSIGNED VARIABLE IS THIS:")
                console.log(userJobTitles9);
            }, error => {
                console.error(error);
            })
        })    
</script> -->


<!-- 
TO DO NEXT:
- DESTROY/BUILD looks to be the way to reload the headers
- To use this, you'll need to:
1. Save the params
2. Build the new table with the new params


Need to figure out how to return a SQL response to the column headers
Need to figure out if you can build the new table with the old Params
Need to re-populate the previous choices in the new table

-->


    </div>
{% endblock content %}


<!-- var url = '/fetch'
var url= "https://examples.wenzhixin.net.cn/examples/bootstrap_table/data" -->





<!-- <h1>Btn2</h1>
<div id='p2'></div>
<button id="btn2"> Button2</button>
<script type="text/javascript">
    document.getElementById('btn2').addEventListener('click', consoleLog);

    function consoleLog(){
        console.log('Clicked it')
        var xhr = new XMLHttpRequest();

        xhr.open('GET', '/data', true);

        xhr.onload = function(){
            if(this.status == 200){
                console.log(this.responseText)
                document.getElementById('p2').innerHTML = 
                this.responseText;
            }
        }

        xhr.send();
    }
</script>

<h1>Btn3</h1>
<div id='p3'></div>
<button id="btn3"> Button3</button>
<script type="text/javascript">
    document.getElementById('btn2').addEventListener('click', consoleLog);

    function consoleLog(){
        console.log('Clicked it')
        // your custom ajax request here
        function ajaxRequest40() {
            var url = '/data'
            $.get(url).then(function (res) {
                params.success(res)
                console.log($.get(url))
        })
    ;
        }
    }
</script> -->